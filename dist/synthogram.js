/*! synthogram - v0.2.0 - 2013-10-11
* Copyright (c) 2013 ; Licensed  */
function Note(a){this.coord=a}function Interval(a){this.coord=a}function add_addsubtract_func(a){return a.add=function(a){var b,c=[];for(b in this)"object"==typeof this[b]&&(c[b]=this[b].add(a));return add_addsubtract_func(c),c},a.subtract=function(a){var b,c=[];for(b in this)"object"==typeof this[b]&&(c[b]=this[b].subtract(a));return add_addsubtract_func(c),c},a}function ModelProperty(a,b,c){this.name=a,this.value=b,this.changeListeners=c}function Model(a){this.properties=a;for(var b in a){var c=a[b];this.properties[b]=new ModelProperty(b,c,[])}}function OscSynth(a,b,c,d,e,f,g,h,i,j){function k(a,b){a.value=b.get(),b.addChangeListener(function(b){a.value=b,console.log("set Parameter value",a.value)})}function l(a,b,c,d){this.input=a.createGain();var e=a.createGain(),f=a.createDelay(),g=a.createGain(),h=a.createGain();k(f.delayTime,b),k(g.gain,c),k(h.gain,d),this.input.connect(f),this.input.connect(e),f.connect(g),f.connect(h),g.connect(f),h.connect(e),this.connect=function(a){e.connect(a)}}function m(){for(var a=0;a<r.length;a++){var b=r[a].oscillator;b.typeByName?b.typeByName(j.get()):b.type=j.get()}}function n(a,b){var c=b,d=Math.pow(2,1/12),e=c*Math.pow(d,a);return e}function o(a,b,c,d){for(var e=[],f=b;b+d>f;f++){var g=a+f,h=Note.fromLatin(g);if("quarter notes"===c)for(var i=0;12>i;i++)e.push({value:n(i,h.frequency()),name:h.latin()+f+"_"+(i+1)});else for(var j=h.scale(c),k=0;k<j.length-1;k++)e.push({value:j[k].frequency(),name:j[k].latin()+f})}return e}function p(a){var b=r[a];return{frequency:b.frequency,name:b.name}}var q=function(){if(window.AudioContext)return new window.AudioContext;throw new Error("Web Audio not supported (could not create audio context")},r=[],s=q(),t=s.createGain();k(t.gain,f),t.connect(s.destination);var u=s.createDynamicsCompressor();u.connect(t);var v=new l(s,g,h,i);v.connect(u);var w=v.input,x=function(){f.addChangeListener(function(a){t.gain.value=a}),b.addChangeListener(y),c.addChangeListener(y),d.addChangeListener(y),e.addChangeListener(y),j.addChangeListener(m)},y=function(){console.log("rebuildOscillators");for(var a=r.length;a>0;)a--,r[a].gainNode.disconnect(),r[a].oscillator.disconnect();r=[],z()},z=function(){console.log("initializing");for(var f=o(b.get(),c.get(),d.get(),e.get()),g=f.length;g>0;)g--,r.push(A(f[g]));a.set(f.length)},A=function(a){var b=s.createOscillator(),c=s.createGain();return b.type=j.get(),b.frequency.value=a.value,c.gain.value=0,b.connect(c),c.connect(w),b.start(0),{oscillator:b,gain:c.gain,gainNode:c,frequency:a.value,name:a.name}},B=.001,C=function(a){for(var b=0;b<r.length;b++){var c=.1*a[b];Math.abs(r[b].gain.value-c)>B&&(r[b].gain.value=c)}};return x(),z(),{play:C,setOscillatorsType:m,compressor:u,masterGain:t.gain,getOscillatorData:p}}function CanvasSource(a,b,c){var d=a.getContext("2d"),e=document.getElementById(b),f=e.getContext("2d"),g=a.width,h=0,i=function(){return a.height/c.get()},j=function(a){f.clearRect(h-1,0,h+1,e.height),f.beginPath(),f.moveTo(a,0),f.lineTo(a,e.height),f.stroke(),h=a};return{getStep:function(b){for(var e=d.getImageData(b,0,1,a.height),f=e.data,g=i(),h=[],k=0,l=c.get();l>k;k++){for(var m=Math.floor(k*g),n=Math.floor((k+1)*g),o=n-m,p=0;n>m;){var q=f[4*m+0],r=f[4*m+1],s=f[4*m+2],t=f[4*m+3],u=0;0!==t&&(u=(255-(q+r+s)/3)*(t/255),(u>255||0>u)&&console.log(q,r,s,t,u)),p+=u,m++}var v=p/o/255;h.push(v)}return j(b),h},numSteps:g,getOscillatorForY:function(a){var b=parseInt(a/i(),10);return b}}}function Sequencer(a,b,c){var d=0,e=b.numSteps,f=!1,g=!1,h=function(){f&&(d=(d+1)%e)},i=function(c){c=parseInt(c,10),d=c;var e=b.getStep(d);a.play(e)},j=function(){function e(){var f=b.getStep(d);a.play(f),h(),window.setTimeout(e,c.get())}console.log("seq.play"),g||(g=!0,e())},k=function(a){f=a,console.log("pauseToggle",f)};return{start:j,setIsPlaying:k,jumpToStep:i,isPlaying:function(){return f}}}function synthogram_init(){$.fn._button=$.fn.button.noConflict(),$.fn._tooltip=$.fn.tooltip.noConflict();var a=new Model({stepDuration:33.33,volume:.5,numOscillators:80,startFrequency:55,delayTime:.125,delayFeedbackGain:.25,delayWetGain:.3,startNote:"C",startOctave:4,musicalScale:"major",numOctaves:2,waveShape:"sine",isPlaying:!1}),b=function(a){return $.map(a,function(a,b){return b}).sort()},c=b(MUSIC.scales);c.push("quarter notes"),$("#oscillatorType").buttonset(),$("#drawingTool").buttonset(),$("#pauseToggle").button({icons:{primary:"ui-icon-play"}}),$("#pauseToggle").tooltip({position:{my:"left+15 center",at:"top"}}),$("#mute").button({icons:{primary:"ui-icon-cancel"}}),$("#volumeUp").button({icons:{primary:"ui-icon-volume-on"}}),$("#volumeDown").button({icons:{primary:"ui-icon-volume-off"}}),$("#save").button(),$("#saveNew").button(),$("#startNote").sgDropdown(a.get("startNote"),b(MUSIC.notes)),$("#startOctave").sgDropdown(a.get("startOctave"),[0,1,2,3,4,5,6,7]),$("#musicalScale").sgDropdown(a.get("musicalScale"),c),$("#numOctaves").sgDropdown(a.get("numOctaves"),[1,2,3,4,5,6]),$("#volumeUp").on("mousedown",function(){var b=Math.min(1,a.getVal("volume")+.05);a.get("volume").set(b)}),$("#volumeDown").on("mousedown",function(){a.get("volume").set(Math.max(0,a.getVal("volume")-.05))}),a.get("volume").addChangeListener(function(a){$("#volumeValue").text(Math.floor(100*a))}),$("#volumeValue").text(100*a.getVal("volume"));var d=!1,e=$("#stepSelector");e.bindMobileEvents(),$("#stepDuration").sgStepDurationSlider(a.get("stepDuration")),$("#knb_delayTime").sgKnob(a.get("delayTime"),0,1e3,1e3,5),$("#knb_delayFeedbackGain").sgKnob(a.get("delayFeedbackGain"),0,100,100,5),$("#knb_delayWetGain").sgKnob(a.get("delayWetGain"),0,100,100,5),$.fn.wPaint.menus.text.items.fontSize.range=[8,9,10,12,14,16,20,24,30,40,50,60],$("#wPaint").wPaint({path:"lib/wpaint/",menuOffsetLeft:-20,menuOffsetTop:-45,lineWidth:"4",fillStyle:"#0000FF",strokeStyle:"#000000",menuHandle:!1});var f=function(a){if(!l)return{name:"--",frequency:0};var b=j.getOscillatorForY(a),c=l.getOscillatorData(b);return c},g=$("#freqHertz"),h=$("#freqName"),i=$(".wPaint-canvas");i.bind("mousemove",function(a){var b=a.pageY-i.offset().top;if(!(b>=i.height()||0>b)){var c=f(b);g.text(c.frequency.toFixed(2)),h.text(c.name)}}).bind("mouseout",function(){g.text("--"),h.text("--")});var j=CanvasSource(i[0],"overlay",a.get("numOscillators"));$(".transparentOverlay").on("touchstart touchmove touchend touchcancel",function(){return!1});var k=function(){var b=10,c=Number($("#overlayGrid").attr("height"))/a.getVal("numOscillators"),d=function(a){var b=f(a);return b.name};console.log("drawing grid",b,c),$("#overlayGrid").sgGrid(b,c),$("#gridLabels").sgGridLabels(c,d),$("#wPaint").wPaint("snapGridVertical",c),$("#wPaint").wPaint("snapGridHorizontal",b)};if($("#oscillatorType").on("change",function(){var b=$("input:checked","#oscillatorType")[0].id;a.get("waveShape").set(b)}),a.get("waveShape").addChangeListener(function(a){$("#"+a).attr("checked","checked").button("refresh")}),$("#mute").on("click",function(){var b=0;0===a.getVal("volume")&&(b=.5),a.get("volume").set(b)}),a.get("volume").addChangeListener(function(a){$("#mute").button("option","icons",{primary:0===a?"ui-icon-radio-off":"ui-icon-cancel"})}),$("#pauseToggle").on("click",function(){a.get("isPlaying").set(!a.getVal("isPlaying")),$("#pauseToggle").button("option","icons",{primary:a.getVal("isPlaying")?"ui-icon-pause":" ui-icon-play"})}),"undefined"==typeof AudioContext)return Muscula.errors.push(new Error("Browser not supported for Synthogram")),$("#notSupportedModal").dialog({height:200,width:350,modal:!0}),void 0;var l=OscSynth(a.get("numOscillators"),a.get("startNote"),a.get("startOctave"),a.get("musicalScale"),a.get("numOctaves"),a.get("volume"),a.get("delayTime"),a.get("delayFeedbackGain"),a.get("delayWetGain"),a.get("waveShape")),m=Sequencer(l,j,a.get("stepDuration"));a.get("isPlaying").addChangeListener(function(a){m.setIsPlaying(a)}),m.start();try{var n=new Firebase("https://sonogram.firebaseio.com/images")}catch(o){}var p="#load/",q=function(b){var c=function(){var a=function(){return Math.floor(16777216*(1+Math.random())).toString(16).substring(1)};return a()+a()};b=b||c();var d=$("#wPaint").wPaint("image"),e=["stepDuration","startFrequency","delayTime","delayFeedbackGain","delayWetGain","startNote","startOctave","musicalScale","numOctaves","waveShape","isPlaying"],f={img:d,settings:{},saveDate:(new Date).toISOString()};$.each(e,function(b,c){f.settings[c]=a.getVal(c)}),n.child(b).set(f,function(){console.log("saved",f),window.location.hash=p+b})};$("#saveNew").on("click",function(){q(null)}),$("#save").on("click",function(){q(r())});var r=function(){var a=window.location.hash,b=null;return 0===a.indexOf(p)&&(b=a.substring(p.length)),console.log("getHashParameters",b),b},s=function(){var b=r();if(console.log("loadInitialImage",b),b)console.log("getting for value",b),n.child(b).once("value",function(b){var c=b.val();console.log("loaded",c),$("#wPaint").wPaint("image",c.img),$.each(c.settings,function(b,c){a.exists(b)&&a.get(b).set(c)})});else{var c=$("#defaultImage").attr("src");$("#wPaint").wPaint("image",c),$("#wPaint").wPaint("_addUndo")}};a.get("numOscillators").addChangeListener(k),a.get("startNote").addChangeListener(k),a.get("startOctave").addChangeListener(k),a.get("musicalScale").addChangeListener(k),k(),e.bind("mousedown",function(a){d=!0,m.jumpToStep(a.pageX-e.offset().left)}),e.bind("mouseup",function(){d=!1}),e.bind("mousemove",function(a){d&&m.jumpToStep(a.pageX-e.offset().left)}),s(),$("#pauseToggle").sgStartupTooltip(2e3,3e3)}var MUSIC={notes:{Fb:[6,-10],Cb:[5,-9],Gb:[5,-8],Db:[4,-7],Ab:[4,-6],Eb:[3,-5],Bb:[3,-4],F:[2,-3],C:[1,-2],G:[1,-1],D:[0,0],A:[0,1],E:[-1,2],B:[-1,3],"F#":[-2,4],"C#":[-3,5],"G#":[-3,6],"D#":[-4,7],"A#":[-4,8],"E#":[-5,9],"B#":[-5,10]},baseFreq:440,baseOffset:[4,1],intervals:{unison:[0,0],"minor second":[3,-5],"major second":[-1,2],"minor third":[2,-3],"major third":[-2,4],fourth:[1,-1],"augmented fourth":[-3,6],tritone:[-3,6],"diminished fifth":[4,-6],fifth:[0,1],"minor sixth":[3,-4],"major sixth":[-1,3],"minor seventh":[2,-2],"major seventh":[-2,5],octave:[1,0]},intervals_semitones:{0:[0,0],1:[3,-5],2:[-1,2],3:[2,-3],4:[-2,4],5:[1,-1],6:[-3,6],7:[0,1],8:[3,-4],9:[-1,3],10:[2,-2],11:[-2,5],12:[1,0]},scales:{major:["major second","major third","fourth","fifth","major sixth","major seventh"],"natural minor":["major second","minor third","fourth","fifth","minor sixth","minor seventh"],"harmonic minor":["major second","minor third","fourth","fifth","minor sixth","major seventh"],"major pentatonic":["major second","major third","fifth","major sixth"],"minor pentatonic":["minor third","fourth","minor sixth","minor seventh"]}};Note.prototype.frequency=function(){return MUSIC.baseFreq*Math.pow(2,(1200*this.coord[0]+700*this.coord[1])/1200)},Note.prototype.accidental=function(){return Math.round((this.coord[1]+MUSIC.baseOffset[1])/7)},Note.prototype.octave=function(){var a=this.accidental();return this.coord[0]+MUSIC.baseOffset[0]+4*a+Math.floor((this.coord[1]+MUSIC.baseOffset[1]-7*a)/2)},Note.prototype.latin=function(){var a=["F","C","G","D","A","E","B"],b=["bb","b","","#","x"],c=this.accidental();return a[this.coord[1]+MUSIC.baseOffset[1]-7*c+3]+b[c+2]},Note.fromLatin=function(a){var b,c,d=[],e=0,f=a.split(/(\d+)/);if(f.length>3){for(b=0;b<(f.length-1)/2;b++)c=MUSIC.notes[f[e]],c=[c[0]+parseInt(f[e+1]),c[1]],c[0]-=MUSIC.baseOffset[0],c[1]-=MUSIC.baseOffset[1],d[b]=new Note(c),e+=2;return d}return c=MUSIC.notes[f[0]],c=[c[0]+parseInt(f[1]),c[1]],c[0]-=MUSIC.baseOffset[0],c[1]-=MUSIC.baseOffset[1],new Note(c)},Note.prototype.scale=function(a){var b,c=[],d=MUSIC.scales[a];for(c.push(this.add("unison")),b=0;b<d.length;b++)c[b+1]=this.add(Interval.fromName(d[b]));return c.push(this.add("octave")),c},Note.prototype.add=function(a){var b,c=[];if("string"==typeof a&&(a=Interval.fromName(a)),a.length){for(b=0;b<a.length;b++)c[b]=this.add(a[b]);return add_addsubtract_func(c),c}return new Note([this.coord[0]+a.coord[0],this.coord[1]+a.coord[1]])},Note.prototype.subtract=function(a){var b,c,d=[];if("string"==typeof a&&(a=Interval.fromName(a)),a.length){for(b=0;b<a.length;b++)d[b]=this.subtract(a[b]);return add_addsubtract_func(d),d}return c=[this.coord[0]-a.coord[0],this.coord[1]-a.coord[1]],"function"==typeof a.frequency?new Interval(c):new Note(c)},Interval.fromName=function(a){return new Interval(MUSIC.intervals[a])},Interval.fromSemitones=function(a){return new Interval(MUSIC.intervals_semitones[a])},Interval.fromTonesSemitones=function(a){return new Interval([-1*a[0]+3*a[1],2*a[0]+-5*a[1]])},Interval.prototype.tone_semitone=function(){return[5*this.coord[0]+3*this.coord[1],2*this.coord[0]+1*this.coord[1]]},Interval.prototype.semitone=function(){var a=this.tone_semitone();return 2*a[0]+a[1]},Interval.prototype.add=function(a){return"string"==typeof a&&(a=Interval.fromName(a)),new Interval([this.coord[0]+a.coord[0],this.coord[1]+a.coord[1]])},Interval.prototype.subtract=function(a){return"string"==typeof a&&(a=Interval.fromName(a)),new Note([this.coord[0]-a.coord[0],this.coord[1]-a.coord[1]])},"undefined"==typeof AudioContext&&"undefined"!=typeof webkitAudioContext&&"undefined"!=typeof webkitAudioContext.prototype.createOscillator&&("undefined"==typeof webkitAudioContext.prototype.createGain&&(webkitAudioContext.prototype.createScriptProcessor=webkitAudioContext.prototype.createJavaScriptNode,webkitAudioContext.prototype.createGain=function(){var a=webkitAudioContext.prototype.createGainNode.call(this);return a},webkitAudioContext.prototype.createDelay=function(){var a=webkitAudioContext.prototype.createDelayNode.call(this);return a},webkitAudioContext.prototype._createOscillator=webkitAudioContext.prototype.createOscillator,webkitAudioContext.prototype.createOscillator=function(){var a=webkitAudioContext.prototype._createOscillator.call(this);return a.start=a.noteOn,a.stop=a.noteOff,a.typeByName=function(b){var c={sine:0,square:1,sawtooth:2,triangle:3},d=c[b];a.type=d},a},webkitAudioContext.prototype._createBufferSource=webkitAudioContext.prototype.createBufferSource,webkitAudioContext.prototype.createBufferSource=function(){var a=webkitAudioContext.prototype._createBufferSource.call(this);return a.start=function(b,c,d){void 0===c?a.noteOn(b):a.noteGrainOn(b,c,d)},a.stop=a.noteOff,a},webkitAudioContext.prototype._createBiquadFilter=webkitAudioContext.prototype.createBiquadFilter,webkitAudioContext.prototype.createBiquadFilter=function(){var a=webkitAudioContext.prototype._createBiquadFilter.call(this);return a},webkitAudioContext.prototype._createDynamicsCompressor=webkitAudioContext.prototype.createDynamicsCompressor,webkitAudioContext.prototype.createDynamicsCompressor=function(){var a=webkitAudioContext.prototype._createDynamicsCompressor.call(this);return a}),window.AudioContext=webkitAudioContext),function(a){"use strict";var b={},c=Math.max,d=Math.min;b.c={},b.c.d=a(document),b.c.t=function(a){return a.originalEvent.touches.length-1},b.o=function(){var c=this;this.o=null,this.$=null,this.i=null,this.g=null,this.v=null,this.cv=null,this.x=0,this.y=0,this.w=0,this.h=0,this.$c=null,this.c=null,this.t=0,this.isInit=!1,this.fgColor=null,this.pColor=null,this.dH=null,this.cH=null,this.eH=null,this.rH=null,this.scale=1,this.relative=!1,this.relativeWidth=!1,this.relativeHeight=!1,this.$div=null,this.run=function(){var b=function(a,b){var d;for(d in b)c.o[d]=b[d];c.init(),c._configure()._draw()};if(!this.$.data("kontroled"))return this.$.data("kontroled",!0),this.extend(),this.o=a.extend({min:this.$.data("min")||0,max:this.$.data("max")||100,stopper:!0,readOnly:this.$.data("readonly")||"readonly"==this.$.attr("readonly"),cursor:this.$.data("cursor")===!0&&30||this.$.data("cursor")||0,thickness:this.$.data("thickness")||.35,lineCap:this.$.data("linecap")||"butt",width:this.$.data("width")||200,height:this.$.data("height")||200,displayInput:null==this.$.data("displayinput")||this.$.data("displayinput"),displayPrevious:this.$.data("displayprevious"),fgColor:this.$.data("fgcolor")||"#87CEEB",inputColor:this.$.data("inputcolor")||this.$.data("fgcolor")||"#87CEEB",font:this.$.data("font")||"Arial",fontWeight:this.$.data("font-weight")||"bold",inline:!1,step:this.$.data("step")||1,draw:null,change:null,cancel:null,release:null,error:null},this.o),this.$.is("fieldset")?(this.v={},this.i=this.$.find("input"),this.i.each(function(b){var d=a(this);c.i[b]=d,c.v[b]=d.val(),d.bind("change",function(){var a={};a[b]=d.val(),c.val(a)})}),this.$.find("legend").remove()):(this.i=this.$,this.v=this.$.val(),""==this.v&&(this.v=this.o.min),this.$.bind("change",function(){c.val(c._validate(c.$.val()))})),!this.o.displayInput&&this.$.hide(),this.$c=a(document.createElement("canvas")),"undefined"!=typeof G_vmlCanvasManager&&G_vmlCanvasManager.initElement(this.$c[0]),this.c=this.$c[0].getContext?this.$c[0].getContext("2d"):null,this.c?(this.scale=(window.devicePixelRatio||1)/(this.c.webkitBackingStorePixelRatio||this.c.mozBackingStorePixelRatio||this.c.msBackingStorePixelRatio||this.c.oBackingStorePixelRatio||this.c.backingStorePixelRatio||1),this.relativeWidth=0!==this.o.width%1&&this.o.width.indexOf("%"),this.relativeHeight=0!==this.o.height%1&&this.o.height.indexOf("%"),this.relative=this.relativeWidth||this.relativeHeight,this.$div=a('<div style="'+(this.o.inline?"display:inline;":"")+'"></div>'),this.$.wrap(this.$div).before(this.$c),this.$div=this.$.parent(),this._carve(),this.v instanceof Object?(this.cv={},this.copy(this.v,this.cv)):this.cv=this.v,this.$.bind("configure",b).parent().bind("configure",b),this._listen()._configure()._xy().init(),this.isInit=!0,this._draw(),this):(this.o.error&&this.o.error(),void 0)},this._carve=function(){if(this.relative){var a=this.relativeWidth?this.$div.parent().width()*parseInt(this.o.width)/100:this.$div.parent().width(),b=this.relativeHeight?this.$div.parent().height()*parseInt(this.o.height)/100:this.$div.parent().height();this.w=this.h=Math.min(a,b)}else this.w=this.o.width,this.h=this.o.height;return this.$div.css({width:this.w+"px",height:this.h+"px"}),this.$c.attr({width:this.w,height:this.h}),1!==this.scale&&(this.$c[0].width=this.$c[0].width*this.scale,this.$c[0].height=this.$c[0].height*this.scale,this.$c.width(this.w),this.$c.height(this.h)),this},this._draw=function(){var a=!0;c.g=c.c,c.clear(),c.dH&&(a=c.dH()),a!==!1&&c.draw()},this._touch=function(a){var d=function(a){var b=c.xy2val(a.originalEvent.touches[c.t].pageX,a.originalEvent.touches[c.t].pageY);b!=c.cv&&(c.cH&&c.cH(b)===!1||(c.change(c._validate(b)),c._draw()))};return this.t=b.c.t(a),d(a),b.c.d.bind("touchmove.k",d).bind("touchend.k",function(){b.c.d.unbind("touchmove.k touchend.k"),c.rH&&c.rH(c.cv)===!1||c.val(c.cv)}),this},this._mouse=function(a){var d=function(a){var b=c.xy2val(a.pageX,a.pageY);b!=c.cv&&(c.cH&&c.cH(b)===!1||(c.change(c._validate(b)),c._draw()))};return d(a),b.c.d.bind("mousemove.k",d).bind("keyup.k",function(a){if(27===a.keyCode){if(b.c.d.unbind("mouseup.k mousemove.k keyup.k"),c.eH&&c.eH()===!1)return;c.cancel()}}).bind("mouseup.k",function(){b.c.d.unbind("mousemove.k mouseup.k keyup.k"),c.rH&&c.rH(c.cv)===!1||c.val(c.cv)}),this},this._xy=function(){var a=this.$c.offset();return this.x=a.left,this.y=a.top,this},this._listen=function(){return this.o.readOnly?this.$.attr("readonly","readonly"):(this.$c.bind("mousedown",function(a){a.preventDefault(),c._xy()._mouse(a)}).bind("touchstart",function(a){a.preventDefault(),c._xy()._touch(a)}),this.relative&&a(window).resize(function(){c._carve().init(),c._draw()}),this.listen()),this},this._configure=function(){return this.o.draw&&(this.dH=this.o.draw),this.o.change&&(this.cH=this.o.change),this.o.cancel&&(this.eH=this.o.cancel),this.o.release&&(this.rH=this.o.release),this.o.displayPrevious?(this.pColor=this.h2rgba(this.o.fgColor,"0.4"),this.fgColor=this.h2rgba(this.o.fgColor,"0.6")):this.fgColor=this.o.fgColor,this},this._clear=function(){this.$c[0].width=this.$c[0].width},this._validate=function(a){return~~((0>a?-.5:.5)+a/this.o.step)*this.o.step},this.listen=function(){},this.extend=function(){},this.init=function(){},this.change=function(){},this.val=function(){},this.xy2val=function(){},this.draw=function(){},this.clear=function(){this._clear()},this.h2rgba=function(a,b){var c;return a=a.substring(1,7),c=[parseInt(a.substring(0,2),16),parseInt(a.substring(2,4),16),parseInt(a.substring(4,6),16)],"rgba("+c[0]+","+c[1]+","+c[2]+","+b+")"},this.copy=function(a,b){for(var c in a)b[c]=a[c]}},b.Dial=function(){b.o.call(this),this.startAngle=null,this.xy=null,this.radius=null,this.lineWidth=null,this.cursorExt=null,this.w2=null,this.PI2=2*Math.PI,this.extend=function(){this.o=a.extend({bgColor:this.$.data("bgcolor")||"#EEEEEE",angleOffset:this.$.data("angleoffset")||0,angleArc:this.$.data("anglearc")||360,inline:!0},this.o)},this.val=function(a){return null==a?this.v:(this.cv=this.o.stopper?c(d(a,this.o.max),this.o.min):a,this.v=this.cv,this.$.val(this.v),this._draw(),void 0)},this.xy2val=function(a,b){var e,f;return e=Math.atan2(a-(this.x+this.w2),-(b-this.y-this.w2))-this.angleOffset,this.angleArc!=this.PI2&&0>e&&e>-.5?e=0:0>e&&(e+=this.PI2),f=~~(.5+e*(this.o.max-this.o.min)/this.angleArc)+this.o.min,this.o.stopper&&(f=c(d(f,this.o.max),this.o.min)),f},this.listen=function(){var b,e,f=this,g=function(a){a.preventDefault();var b=a.originalEvent,c=b.detail||b.wheelDeltaX,d=b.detail||b.wheelDeltaY,e=parseInt(f.$.val())+(c>0||d>0?f.o.step:0>c||0>d?-f.o.step:0);f.cH&&f.cH(e)===!1||f.val(e)},h=1,i={37:-f.o.step,38:f.o.step,39:f.o.step,40:-f.o.step};this.$.bind("keydown",function(g){var j=g.keyCode;if(j>=96&&105>=j&&(j=g.keyCode=j-48),b=parseInt(String.fromCharCode(j)),isNaN(b)&&(13!==j&&8!==j&&9!==j&&189!==j&&g.preventDefault(),a.inArray(j,[37,38,39,40])>-1)){g.preventDefault();var k=parseInt(f.$.val())+i[j]*h;f.o.stopper&&(k=c(d(k,f.o.max),f.o.min)),f.change(k),f._draw(),e=window.setTimeout(function(){h*=2},30)}}).bind("keyup",function(){isNaN(b)?e&&(window.clearTimeout(e),e=null,h=1,f.val(f.$.val())):f.$.val()>f.o.max&&f.$.val(f.o.max)||f.$.val()<f.o.min&&f.$.val(f.o.min)}),this.$c.bind("mousewheel DOMMouseScroll",g),this.$.bind("mousewheel DOMMouseScroll",g)},this.init=function(){(this.v<this.o.min||this.v>this.o.max)&&(this.v=this.o.min),this.$.val(this.v),this.w2=this.w/2,this.cursorExt=this.o.cursor/100,this.xy=this.w2*this.scale,this.lineWidth=this.xy*this.o.thickness,this.lineCap=this.o.lineCap,this.radius=this.xy-this.lineWidth/2,this.o.angleOffset&&(this.o.angleOffset=isNaN(this.o.angleOffset)?0:this.o.angleOffset),this.o.angleArc&&(this.o.angleArc=isNaN(this.o.angleArc)?this.PI2:this.o.angleArc),this.angleOffset=this.o.angleOffset*Math.PI/180,this.angleArc=this.o.angleArc*Math.PI/180,this.startAngle=1.5*Math.PI+this.angleOffset,this.endAngle=1.5*Math.PI+this.angleOffset+this.angleArc;var a=c(String(Math.abs(this.o.max)).length,String(Math.abs(this.o.min)).length,2)+2;this.o.displayInput&&this.i.css({width:(this.w/2+4>>0)+"px",height:(this.w/3>>0)+"px",position:"absolute","vertical-align":"middle","margin-top":(this.w/3>>0)+"px","margin-left":"-"+(3*this.w/4+2>>0)+"px",border:0,background:"none",font:this.o.fontWeight+" "+(this.w/a>>0)+"px "+this.o.font,"text-align":"center",color:this.o.inputColor||this.o.fgColor,padding:"0px","-webkit-appearance":"none"})||this.i.css({width:"0px",visibility:"hidden"})},this.change=function(a){this.cv=a,this.$.val(a)},this.angle=function(a){return(a-this.o.min)*this.angleArc/(this.o.max-this.o.min)},this.draw=function(){var a,b,c=this.g,d=this.angle(this.cv),e=this.startAngle,f=e+d,g=1;c.lineWidth=this.lineWidth,c.lineCap=this.lineCap,this.o.cursor&&(e=f-this.cursorExt)&&(f+=this.cursorExt),c.beginPath(),c.strokeStyle=this.o.bgColor,c.arc(this.xy,this.xy,this.radius,this.endAngle,this.startAngle,!0),c.stroke(),this.o.displayPrevious&&(b=this.startAngle+this.angle(this.v),a=this.startAngle,this.o.cursor&&(a=b-this.cursorExt)&&(b+=this.cursorExt),c.beginPath(),c.strokeStyle=this.pColor,c.arc(this.xy,this.xy,this.radius,a,b,!1),c.stroke(),g=this.cv==this.v),c.beginPath(),c.strokeStyle=g?this.o.fgColor:this.fgColor,c.arc(this.xy,this.xy,this.radius,e,f,!1),c.stroke()},this.cancel=function(){this.val(this.v)}},a.fn.dial=a.fn.knob=function(c){return this.each(function(){var d=new b.Dial;d.o=c,d.$=a(this),d.run()}).parent()}}(jQuery),!function(a){"use strict";function b(b,c){this.$el=a(b),this.options=c,this.init=!1,this.menus={primary:null,active:null,all:{}},this.previousMode=null,this.width=this.$el.width(),this.height=this.$el.height(),this.ctxBgResize=!1,this.ctxResize=!1,this.generate(),this._init()}function c(a,b,c){this.wPaint=a,this.options=c,this.name=b,this.type=a.menus.primary?"secondary":"primary",this.docked=!0,this.dockOffset={left:0,top:0},this.generate()}b.prototype={generate:function(){function b(b){var c=b?b.capitalize():"",d="canvas"+c,e="ctx"+c;return f[d]=document.createElement("canvas"),f[e]=f[d].getContext("2d"),f["$"+d]=a(f[d]),f["$"+d].attr("class","wPaint-canvas"+(b?"-"+b:"")).attr("width",f.width+"px").attr("height",f.height+"px").css({position:"absolute",left:0,top:0}),f.$el.append(f["$"+d]),f["$"+d]}function c(a){a.preventDefault(),a.stopPropagation(),f.draw=!0,a.canvasEvent="down",f._closeSelectBoxes(),f._callShapeFunc.apply(f,[a])}function d(a){f.draw&&(a.canvasEvent="move",f._callShapeFunc.apply(f,[a]))}function e(a){f.draw&&(f.draw=!1,a.canvasEvent="up",f._callShapeFunc.apply(f,[a]))}if(this.init)return this;var f=this;b("bg"),b("").on("mousedown",c).bindMobileEvents(),b("temp").hide(),a(document).on("mousemove",d).on("mousedown",a.proxy(this._closeSelectBoxes,this)).on("mouseup",e),this.setTheme(this.options.theme)},_init:function(){var a=null,b=null;this.init=!0;for(a in this.options)b="set"+a.capitalize(),this[b]&&this[b](this.options[a]);this._fixMenus(),this.menus.primary._getIcon(this.options.mode).trigger("click")},resize:function(){var a=this.getBg(),b=this.getImage();this.width=this.$el.width(),this.height=this.$el.height(),this.canvasBg.width=this.width,this.canvasBg.height=this.height,this.canvas.width=this.width,this.canvas.height=this.height,this.ctxBgResize===!1&&(this.ctxBgResize=!0,this.setBg(a,!0)),this.ctxResize===!1&&(this.ctxResize=!0,this.setImage(b,"",!0))},setTheme:function(a){var b,c;for(a=a.split(" "),this.$el.attr("class",(this.$el.attr("class")||"").replace(/wPaint-theme-.+\s|wPaint-theme-.+$/,"")),b=0,c=a.length;c>b;b++)this.$el.addClass("wPaint-theme-"+a[b])},setMode:function(a){this.setCursor(a),this.previousMode=this.options.mode,this.options.mode=a},setImage:function(b,c,d){function e(){var a=1,b=0,e=0,i=0,j=0,k=g.width,l=g.height;d||((g.width>f.width||g.height>f.height)&&(b=f.width/g.width,e=f.height/g.height,a=e>b?b:e,k=g.width*a,l=g.height*a),i=(f.width-k)/2,j=(f.height-l)/2),h.clearRect(0,0,f.width,f.height),h.drawImage(g,i,j,k,l),h||f._imageOnload(),f[c+"Resize"]=!1}if(!b)return!0;var f=this,g=null,h="";c="ctx"+(c||"").capitalize(),h=this[c],window.rgbHex(b)?(h.clearRect(0,0,this.width,this.height),h.fillStyle=b,h.rect(0,0,this.width,this.height),h.fill()):(g=new Image,g.src=b.toString(),a(g).load(e))},setBg:function(a,b){return a?(this.setImage(a,"bg",b),void 0):!0},setCursor:function(b){b=a.fn.wPaint.cursors[b]||a.fn.wPaint.cursors["default"],this.$el.css("cursor",'url("'+this.options.path+b.path+'") '+b.left+" "+b.top+", default")},getImage:function(b){var c=document.createElement("canvas"),d=c.getContext("2d");return b=b===!1?!1:!0,a(c).css({display:"none",position:"absolute",left:0,top:0}).attr("width",this.width).attr("height",this.height),b&&d.drawImage(this.canvasBg,0,0),d.drawImage(this.canvas,0,0),c.toDataURL()},getBg:function(){return this.canvasBg.toDataURL()},_displayStatus:function(b){var c=this;this.$status||(this.$status=a('<div class="wPaint-status"></div>'),this.$el.append(this.$status)),this.$status.html(b),clearTimeout(this.displayStatusTimer),this.$status.fadeIn(500,function(){c.displayStatusTimer=setTimeout(function(){c.$status.fadeOut(500)},1500)})},_showModal:function(a){function b(){d.remove(),e.remove(),c._createModal(a)}var c=this,d=this.$el.children(".wPaint-modal-bg"),e=this.$el.children(".wPaint-modal");d.length?e.fadeOut(500,b):this._createModal(a)},_createModal:function(b){function c(){f.fadeOut(500,d)}function d(){e.remove(),f.remove()}b=a('<div class="wPaint-modal-content"></div>').append(b.children());var e=a('<div class="wPaint-modal-bg"></div>'),f=a('<div class="wPaint-modal"></div>'),g=a('<div class="wPaint-modal-holder"></div>'),h=a('<div class="wPaint-modal-close">X</div>');h.on("click",c),f.append(g.append(b)).append(h),this.$el.append(e).append(f),f.css({left:this.$el.outerWidth()/2-f.outerWidth(!0)/2,top:this.$el.outerHeight()/2-f.outerHeight(!0)/2}),f.fadeIn(500)},_createMenu:function(a,b){return b=b||{},b.alignment=this.options.menuOrientation,b.handle=this.options.menuHandle,new c(this,a,b)},_fixMenus:function(){function b(b,d){var e=a(d),f=e.clone();f.appendTo(c.$el),f.outerHeight()===f.get(0).scrollHeight&&e.css({overflowY:"auto"}),f.remove()}var c=this,d=null;for(var e in this.menus.all)d=c.menus.all[e].$menu.find(".wPaint-menu-select-holder"),d.length&&d.children().each(b)},_closeSelectBoxes:function(a){var b,c;for(b in this.menus.all)c=this.menus.all[b].$menuHolder.children(".wPaint-menu-icon-select"),a&&(c=c.not(".wPaint-menu-icon-name-"+a.name)),c.children(".wPaint-menu-select-holder").hide()},_imageOnload:function(){},_callShapeFunc:function(a){var b=this.$canvas.offset(),c=a.canvasEvent.capitalize(),d="_draw"+this.options.mode.capitalize()+c;a.pageX=Math.floor(a.pageX-b.left),a.pageY=Math.floor(a.pageY-b.top),this[d]&&this[d].apply(this,[a]),this.options["draw"+c]&&this.options["_draw"+c].apply(this,[a])},_stopPropagation:function(a){a.stopPropagation()},_drawShapeDown:function(a){this.$canvasTemp.css({left:a.PageX,top:a.PageY}).attr("width",0).attr("height",0).show(),this.canvasTempLeftOriginal=a.pageX,this.canvasTempTopOriginal=a.pageY,this.options.onShapeDown&&this.options.onShapeDown.apply(this,[a])},_drawShapeMove:function(b,c){var d=this.canvasTempLeftOriginal,e=this.canvasTempTopOriginal;c=c||2,b.left=b.pageX<d?b.pageX:d,b.top=b.pageY<e?b.pageY:e,b.width=Math.abs(b.pageX-d),b.height=Math.abs(b.pageY-e),b.x=this.options.lineWidth/2*c,b.y=this.options.lineWidth/2*c,b.w=b.width-this.options.lineWidth*c,b.h=b.height-this.options.lineWidth*c,a(this.canvasTemp).css({left:b.left,top:b.top}).attr("width",b.width).attr("height",b.height),this.canvasTempLeftNew=b.left,this.canvasTempTopNew=b.top,c=c||2,this.ctxTemp.fillStyle=this.options.fillStyle,this.ctxTemp.strokeStyle=this.options.strokeStyle,this.ctxTemp.lineWidth=this.options.lineWidth*c,this.options.onShapeDown&&this.options.onShapeMove.apply(this,[b])},_drawShapeUp:function(a){this.ctx.drawImage(this.canvasTemp,this.canvasTempLeftNew,this.canvasTempTopNew),this.$canvasTemp.hide(),this.options.onShapeDown&&this.options.onShapeUp.apply(this,[a])},_drawDropperDown:function(a){var b={x:a.pageX,y:a.pageY},c=this._getPixel(this.ctx,b),d=null;d="rgba("+[c.r,c.g,c.b,c.a].join(",")+")",this.options[this.dropper]=d,this.menus.active._getIcon(this.dropper).wColorPicker("color",d)},_drawDropperUp:function(){this.setMode(this.previousMode)},_getPixel:function(a,b){var c=a.getImageData(0,0,this.width,this.height),d=c.data,e=4*(b.y*c.width+b.x);return{r:d[e],g:d[e+1],b:d[e+2],a:d[e+3]}}},c.prototype={generate:function(){var b=null;this.$menu=a('<div class="wPaint-menu"></div>'),this.$menuHolder=a('<div class="wPaint-menu-holder wPaint-menu-name-'+this.name+'"></div>'),this.options.handle?this.$menuHandle=this._createHandle():this.$menu.addClass("wPaint-menu-nohandle"),"primary"===this.type?(this.wPaint.menus.primary=this,this.setOffsetLeft(this.options.offsetLeft),this.setOffsetTop(this.options.offsetTop)):"secondary"===this.type&&this.$menu.hide(),this.$menu.append(this.$menuHolder.append(this.$menuHandle)),this.reset(),this.setAlignment(this.options.alignment),this.wPaint.$el.append(this.$menu),b=this.$menu.css("left"),this.$menu.css("left",-1e4),this.$menu.width(this.$menu.width()),this.$menu.css("left",b),"secondary"===this.type&&("horizontal"===this.options.alignment?this.dockOffset.top=this.wPaint.menus.primary.$menu.outerHeight(!0):this.dockOffset.left=this.wPaint.menus.primary.$menu.outerWidth(!0))
},reset:function(){function b(a){d._appendItem(a)}var c,d=this,e=a.fn.wPaint.menus[this.name];for(c in e.items)this.$menuHolder.children(".wPaint-menu-icon-name-"+c).length||(e.items[c].name=c,e.items[c].img=d.wPaint.options.path+(e.items[c].img||e.img),b(e.items[c]))},_appendItem:function(a){var b=this["_createIcon"+a.icon.capitalize()](a);a.after?this.$menuHolder.children(".wPaint-menu-icon-name-"+a.after).after(b):this.$menuHolder.append(b)},setOffsetLeft:function(a){this.$menu.css({left:a})},setOffsetTop:function(a){this.$menu.css({top:a})},setAlignment:function(a){this.$menu.attr("class",this.$menu.attr("class").replace(/wPaint-menu-alignment-.+\s|wPaint-menu-alignment-.+$/,"")),this.$menu.addClass("wPaint-menu-alignment-"+a)},_createHandle:function(){function b(){e.docked=!1,e._setDrag()}function c(){a.each(e.$menu.data("ui-draggable").snapElements,function(a,b){var c=e.$menu.offset(),d=e.wPaint.menus.primary.$menu.offset();e.dockOffset.left=c.left-d.left,e.dockOffset.top=c.top-d.top,e.docked=b.snapping}),e._setDrag()}function d(){e._setIndex()}var e=this,f=a('<div class="wPaint-menu-handle"></div>');return this.$menu.draggable({handle:f}),"secondary"===this.type&&(this.$menu.draggable("option","snap",this.wPaint.menus.primary.$menu),this.$menu.draggable("option","start",b),this.$menu.draggable("option","stop",c),this.$menu.draggable("option","drag",d)),f.bindMobileEvents(),f},_createIconBase:function(b){function c(b){var c=a(b.currentTarget);c.siblings(".hover").removeClass("hover"),c.hasClass("disabled")||c.addClass("hover")}function d(b){a(b.currentTarget).removeClass("hover")}function e(){f.wPaint.menus.active=f}var f=this,g=a('<div class="wPaint-menu-icon wPaint-menu-icon-name-'+b.name+'"></div>'),h=a('<div class="wPaint-menu-icon-img"></div>'),i=h.realWidth(null,null,this.wPaint.$el);return g.attr("title",b.title).on("mousedown",a.proxy(this.wPaint._closeSelectBoxes,this.wPaint,b)).on("mouseenter",c).on("mouseleave",d).on("click",e),a.isNumeric(b.index)&&h.css({backgroundImage:"url("+b.img+")",backgroundPosition:-i*b.index+"px 0px"}),g.append(h)},_createIconGroup:function(b){function c(){h.children(".wPaint-menu-select-holder").is(":visible")||b.callback.apply(f.wPaint,[])}function d(){h.addClass("active").siblings(".active").removeClass("active")}function e(){h.attr("title",b.title).off("click.setIcon").on("click.setIcon",c),h.children(".wPaint-menu-icon-img").css(g),b.callback.apply(f.wPaint,[])}var f=this,g={backgroundImage:"url("+b.img+")"},h=this.$menuHolder.children(".wPaint-menu-icon-group-"+b.group),i=h.length,j=null,k=null,l=null,m=0;return i||(h=this._createIconBase(b).addClass("wPaint-menu-icon-group wPaint-menu-icon-group-"+b.group).on("click.setIcon",c).on("mousedown",a.proxy(this._iconClick,this))),m=h.children(".wPaint-menu-icon-img").realWidth(null,null,this.wPaint.$el),g.backgroundPosition=-m*b.index+"px center",j=h.children(".wPaint-menu-select-holder"),j.length||(j=this._createSelectBox(h),j.children().on("click",d)),l=a('<div class="wPaint-menu-icon-select-img"></div>').attr("title",b.title).css(g),k=this._createSelectOption(j,l).addClass("wPaint-menu-icon-name-"+b.name).on("click",e),b.after&&j.children(".wPaint-menu-select").children(".wPaint-menu-icon-name-"+b.after).after(k),i?void 0:h},_createIconGeneric:function(a){return this._createIconActivate(a)},_createIconActivate:function(a){function b(b){"generic"!==a.icon&&c._iconClick(b),a.callback.apply(c.wPaint,[b])}if(a.group)return this._createIconGroup(a);var c=this,d=this._createIconBase(a);return d.on("click",b),d},_isIconDisabled:function(a){return this.$menuHolder.children(".wPaint-menu-icon-name-"+a).hasClass("disabled")},_setIconDisabled:function(a,b){var c=this.$menuHolder.children(".wPaint-menu-icon-name-"+a);b?c.addClass("disabled").removeClass("hover"):c.removeClass("disabled")},_getIcon:function(a){return this.$menuHolder.children(".wPaint-menu-icon-name-"+a)},_iconClick:function(b){var c=a(b.currentTarget),d=this.wPaint.menus.all;for(var e in d)d[e]&&"secondary"===d[e].type&&d[e].$menu.hide();c.siblings(".active").removeClass("active"),c.hasClass("disabled")||c.addClass("active")},_createIconToggle:function(a){function b(){d.toggleClass("active"),a.callback.apply(c.wPaint,[d.hasClass("active")])}var c=this,d=this._createIconBase(a);return d.on("click",b),d},_createIconSelect:function(b){function c(c){h.children(".wPaint-menu-icon-img").html(a(c.currentTarget).html()),b.callback.apply(g.wPaint,[a(c.currentTarget).html()])}var d,e,f,g=this,h=this._createIconBase(b),i=this._createSelectBox(h);for(d=0,e=b.range.length;e>d;d++)f=this._createSelectOption(i,b.range[d]),f.on("click",c),b.useRange&&f.css(b.name,b.range[d]);return h},_createSelectBox:function(b){function c(a){a.stopPropagation(),g.hide()}function d(){i=setTimeout(function(){g.toggle()},200)}function e(){clearTimeout(i)}function f(){g.toggle()}var g=a('<div class="wPaint-menu-select-holder"></div>'),h=a('<div class="wPaint-menu-select"></div>'),i=null;return g.on("mousedown mouseup",this.wPaint._stopPropagation).on("click",c).hide(),"horizontal"===this.options.alignment?g.css({left:0,top:b.children(".wPaint-menu-icon-img").realHeight("outer",!0,this.wPaint.$el)}):g.css({left:b.children(".wPaint-menu-icon-img").realWidth("outer",!0,this.wPaint.$el),top:0}),b.addClass("wPaint-menu-icon-select").append('<div class="wPaint-menu-icon-group-arrow"></div>').append(g.append(h)),b.hasClass("wPaint-menu-icon-group")?b.on("mousedown",d).on("mouseup",e):b.on("click",f),g},_createSelectOption:function(b,c){var d=b.children(".wPaint-menu-select"),e=a('<div class="wPaint-menu-select-option"></div>').append(c);return d.children().length||e.addClass("first"),d.append(e),e},_setSelectValue:function(a,b){this._getIcon(a).children(".wPaint-menu-icon-img").html(b)},_createIconColorPicker:function(a){function b(){"dropper"===e.wPaint.options.mode&&e.wPaint.setMode(e.wPaint.previousMode)}function c(b){a.callback.apply(e.wPaint,[b])}function d(){f.trigger("click"),e.wPaint.dropper=a.name,e.wPaint.setMode("dropper")}var e=this,f=this._createIconBase(a);return f.on("click",b).addClass("wPaint-menu-colorpicker").wColorPicker({mode:"click",generateButton:!1,dropperButton:!0,onSelect:c,onDropper:d}),f},_setColorPickerValue:function(a,b){this._getIcon(a).children(".wPaint-menu-icon-img").css("backgroundColor",b)},_createIconMenu:function(a){function b(){c.wPaint.setCursor(a.name);var b=c.wPaint.menus.all[a.name];b.$menu.toggle(),b._setDrag()}var c=this,d=this._createIconActivate(a);return d.on("click",b),d},_setDrag:function(){var b=this.$menu,c=null,d=null;b.is(":visible")&&(this.docked&&(c=d=a.proxy(this._setPosition,this),this._setPosition()),this.wPaint.menus.primary.$menu.draggable("option","drag",c),this.wPaint.menus.primary.$menu.draggable("option","stop",d))},_setPosition:function(){var a=this.wPaint.menus.primary.$menu.position();this.$menu.css({left:a.left+this.dockOffset.left,top:a.top+this.dockOffset.top})},_setIndex:function(){var a=this.wPaint.menus.primary.$menu.offset(),b=this.$menu.offset();b.top<a.top||b.left<a.left?this.$menu.addClass("wPaint-menu-behind"):this.$menu.removeClass("wPaint-menu-behind")}},a.support.canvas=document.createElement("canvas").getContext,a.fn.wPaint=function(c,d){function e(b,e){var f=a(e).data("wPaint"),g=null;f&&(g=(d?"set":"get")+c.charAt(0).toUpperCase()+c.substring(1).toLowerCase(),f[c]?f[c].apply(f,[d]):d?(f[g]&&f[g].apply(f,[d]),f.options[c]&&(f.options[c]=d)):f[g]?h.push(f[g].apply(f,[d])):f.options[c]?h.push(f.options[c]):h.push(null))}function f(b,c){return a.support.canvas?(g(c),void 0):(a(c).html("Browser does not support HTML5 canvas, please upgrade to a more modern browser."),!1)}function g(d){var e=a.data(d,"wPaint");if(!e){var f=a.extend(!0,{},c);f.lineWidth=parseInt(f.lineWidth,10),f.fontSize=parseInt(f.fontSize,10),e=new b(d,f),a.data(d,"wPaint",e)}return e}if("string"==typeof c){var h=[],i=null;return i=this.each(e),1===h.length?h[0]:h.length>0?h:i}return c=a.extend({},a.fn.wPaint.defaults,c),this.each(f)},a.fn.wPaint.extend=function(a,d){function e(c){if(d[c]){var e=b.prototype[c],f=a[c];d[c]=function(){e.apply(this,arguments),f.apply(this,arguments)}}else d[c]=a[c]}var f;d="menu"===d?c.prototype:b.prototype;for(f in a)e(f)},a.fn.wPaint.menus={},a.fn.wPaint.cursors={},a.fn.wPaint.defaults={path:"/",theme:"standard classic",autoScaleImage:!0,autoCenterImage:!0,menuHandle:!0,menuOrientation:"horizontal",menuOffsetLeft:5,menuOffsetTop:5,bg:null,image:null,onShapeDown:null,onShapeMove:null,onShapeUp:null}}(jQuery),function(){String.prototype.capitalize||(String.prototype.capitalize=function(){return this.slice(0,1).toUpperCase()+this.slice(1)})}(),function(a){a.fn.realWidth=function(b,c,d){var e=null,f=null,g=null;return b="inner"===b||"outer"===b?b:"",g=""===b?"width":b+"Width",c=c===!0?!0:!1,f=a(this).clone().css({position:"absolute",left:-1e4}).appendTo(d||"body"),e=c?f[g](c):f[g](),f.remove(),e},a.fn.realHeight=function(b,c,d){var e=null,f=null,g=null;return b="inner"===b||"outer"===b?b:"",g=""===b?"height":b+"Height",c=c===!0?!0:!1,f=a(this).clone().css({position:"absolute",left:-1e4}).appendTo(d||"body"),e=c?f[g](c):f[g](),f.remove(),e},a.fn.bindMobileEvents=function(){a(this).on("touchstart touchmove touchend touchcancel",function(){var a=event.changedTouches,b=a[0],c="";switch(event.type){case"touchstart":c="mousedown";break;case"touchmove":c="mousemove",event.preventDefault();break;case"touchend":c="mouseup";break;default:return}var d=document.createEvent("MouseEvent");d.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null),b.target.dispatchEvent(d)})}}(jQuery),window.rgbHex=function(){function a(a){return!isNaN(parseFloat(a))&&isFinite(a)}function b(a){return a.replace(/^\s+|\s+$/g,"")}function c(c){return c=b(c),a(c)&&c>=0&&255>=c}function d(a){return/^[0-9a-f]{3}$|^[0-9a-f]{6}$/i.test(b(a))}function e(a){return a=parseInt(a,10).toString(16),1===a.length?"0"+a:a}function f(a){return parseInt(a,16).toString()}function g(b){return b=b.split(","),(3===b.length||4===b.length)&&c(b[0])&&c(b[1])&&c(b[2])?4!==b.length||a(b[3])?"#"+e(b[0]).toUpperCase()+e(b[1]).toUpperCase()+e(b[2]).toUpperCase():null:null}function h(a){return d(a)?(3===a.length&&(a=a.charAt(0)+a.charAt(0)+a.charAt(1)+a.charAt(1)+a.charAt(2)+a.charAt(2)),"rgb("+f(a.substr(0,2))+","+f(a.substr(2,2))+","+f(a.substr(4,2))+")"):void 0}function i(a){return a.replace(/\s/g,"")}return function(a){if(!a)return null;var c=null,d=/^rgba?\((.*)\);?$/,e=/^#/;return a=b(a.toString()),"transparent"===a?a:"rgba(0,0,0,0)"===i(a)?"transparent":d.test(a)?g(a.match(d)[1]):e.test(a)?h(a.split("#").reverse()[0]):(c=a.split(","),1===c.length?h(a):3===c.length||4===c.length?g(a):void 0)}}(),jQuery&&jQuery.extend({rgbHex:function(a){return window.rgbHex(a)}}),!function(a){function b(b,c){this.$el=a(b),this.options=c,this.init=!1,this.generate()}b.prototype={generate:function(){return this.$colorPicker||(this.$noneColorPalette=this._createPalette("none",[["transparent"]]),this.$simpleColorPalette=this._createPalette("simple",a.fn.wColorPicker.simpleColors),this.$mixedColorPalette=this._createPalette("mixed",a.fn.wColorPicker.mixedColors),this.$colorTarget=a('<div class="wColorPicker-color-target"></div>'),this.$customInput=a('<input type="text" class="wColorPicker-custom-input"/>').keyup(a.proxy(this._customInputKeyup,this)),this.options.dropperButton&&(this.$dropperButton=this._createDropperButton()),this.$colorPickerPalettesHolder=a('<div class="wColorPicker-palettes-holder"></div>').append(this.$noneColorPalette).append(this.$colorTarget).append(this.$customInput).append(this.$dropperButton).append("<br/>").append(this.$simpleColorPalette).append(this.$mixedColorPalette),this.$colorPickerHolder=a('<div class="wColorPicker-holder"></div>').append(this.$colorPickerPalettesHolder),this.$colorPickerBg=a('<div class="wColorPicker-bg"></div>'),this.$colorPicker=a('<div class="wColorPicker" title=""></div>').mouseenter(function(a){a.stopPropagation()}).bind("mouseenter mousemove click",function(a){a.stopPropagation()}).append(this.$colorPickerBg).append(this.$colorPickerHolder),this.setOpacity(this.options.opacity),this.setTheme(this.options.theme),this.setColor(this.options.color),a("body").append(this.$colorPicker),this.width=this.$colorPickerPalettesHolder.width(),this.height=this.$colorPickerPalettesHolder.height(),this.$colorPickerPalettesHolder.width(this.width),this.$colorPickerPalettesHolder.height(this.height),this.$el.append(this.$colorPicker),this.setMode(this.options.mode),this.setPosition(this.options.position)),this.init=!0,this},setTheme:function(a){this.$colorPicker.attr("class",this.$colorPicker.attr("class").replace(/wColorPicker-theme-.+\s|wColorPicker-theme-.+$/,"")),this.$colorPicker.addClass("wColorPicker-theme-"+a)},setOpacity:function(a){this.$colorPickerBg.css("opacity",a)},setColor:function(a){return window.rgbHex(a)?(this.options.color=a,this.$colorTarget.css("backgroundColor",a),this.$customInput.val(a),this.init&&this.options.onSelect&&this.options.onSelect.apply(this,[a]),void 0):!0},setMode:function(b){var c=this,d=function(){c._toggleEffect("show")},e=function(){c._toggleEffect("hide")};if("flat"===b?this.$colorPicker.removeClass("wColorPicker-zindex").css({position:"relative",display:""}):this.$colorPicker.addClass("wColorPicker-zindex").css({position:"absolute"}).hide(),this.$el.find("wColorPicker-button").remove(),this.$el.unbind("mouseenter",d).unbind("mouseleave",e),a(document).unbind("click",e),"flat"!==b){var f=null,g=null,h=function(a){a.stopPropagation(),c.options.generateButton&&g.css("backgroundColor",c.options.color),c._toggleEffect()};this.options.generateButton&&(f=a('<div class="wColorPicker-button"></div>'),g=a('<div class="wColorPicker-button-color"></div>').css("backgroundColor",this.options.color),this.$el.append(f),f.append(g.height(this.$el.height()-f.outerHeight(!0)))),this.$noneColorPalette.bind("click",h),this.$simpleColorPalette.bind("click",h),this.$mixedColorPalette.bind("click",h)}"click"===b?(this.$el.click(function(a){c._toggleEffect(),a.stopPropagation()}),this.$colorPicker.click(function(a){a.stopPropagation()}),a(document).bind("click",e)):"hover"===b&&this.$el.bind("mouseenter",d).bind("mouseleave",e)},setEffect:function(a){return"flat"===this.options.mode?!0:(this.$colorPicker.css("opacity",1),this.$colorPickerHolder.width(this.width).height(this.height),"fade"===a?this.$colorPicker.css("opacity",0):"slide"===a&&this.$colorPickerHolder.width("x"===this.positionAxis?0:this.width).height("y"===this.positionAxis?0:this.height),void 0)},setPosition:function(a){if("flat"===this.options.mode)return!0;var b=this.$el.outerWidth(),c=this.$el.outerHeight(),d=this.$el.outerWidth()/2-this.$colorPicker.outerWidth()/2,e=this.$el.outerHeight()/2-this.$colorPicker.outerHeight()/2,f={left:"",right:"",top:"",bottom:""},g=this.options.position.charAt(0);switch("t"===g||"b"===g?this.positionAxis="y":("l"===g||"r"===g)&&(this.positionAxis="x"),a){case"tl":f.left=0,f.bottom=c;break;case"tc":f.left=d,f.bottom=c;break;case"tr":f.right=0,f.bottom=c;break;case"rt":f.left=b,f.top=0;break;case"rm":f.left=b,f.top=e;break;case"rb":f.left=b,f.bottom=0;break;case"br":f.right=0,f.top=c;break;case"bc":f.left=d,f.top=c;break;case"bl":f.left=0,f.top=c;break;case"lb":f.right=b,f.bottom=0;break;case"lm":f.right=b,f.top=e;break;case"lt":f.right=b,f.top=0}this.$colorPicker.css(f),this.setEffect(this.options.effect)},_createPalette:function(b,c){var d=0,e=0,f=0,g=0,h=null,i=a('<div class="wColorPicker-palette wColorPicker-palette-'+b+'"></div>');for(d=0,e=c.length;e>d;d++){for(f=0,g=c[d].length;g>f;f++)h=this._createColor(f,c[d][f]),0===d&&h.addClass("wColorPicker-palette-color-top"),0===f&&h.addClass("wColorPicker-palette-color-left"),i.append(h);e>d&&i.append("<br/>")}return i},_createColor:function(b,c){var d=this;return a('<div class="wColorPicker-palette-color"></div>').attr("id","wColorPicker-palette-color-"+b).addClass("wColorPicker-palette-color-"+b).css("backgroundColor",c).hover(function(){d._colorMouseenter(a(this))},function(){d._colorMouseleave(a(this))}).click(function(){d.setColor(window.rgbHex(a(this).css("backgroundColor")))})},_createDropperButton:function(){return a('<div class="wColorPicker-dropper"></div>').click(a.proxy(this.options.onDropper,this))},_customInputKeyup:function(b){var c=a(b.target).val();window.rgbHex(c)&&(this.$colorTarget.css("backgroundColor",c),13===b.keyCode&&this.setColor(c))},_colorMouseenter:function(a){var b=window.rgbHex(a.css("backgroundColor"));a.addClass("active").prev().addClass("active-right"),a.prevAll("."+a.attr("id")+":first").addClass("active-bottom"),this.$colorTarget.css("backgroundColor",b),this.$customInput.val(b),this.options.onMouseover&&this.options.onMouseover.apply(this,[b])},_colorMouseleave:function(a){a.removeClass("active").prev().removeClass("active-right"),a.prevAll("."+a.attr("id")+":first").removeClass("active-bottom"),this.$colorTarget.css("backgroundColor",this.options.color),this.$customInput.val(this.options.color),this.options.onMouseout&&this.options.onMouseout.apply(this,[this.options.color])},_toggleEffect:function(a){var b=this.$colorPicker.hasClass("wColorPicker-visible");(!a||"show"===a&&b===!1||"hide"===a&&b===!0)&&(b||this.setPosition(this.options.position),this["_"+this.options.effect+"Effect"+(b?"Hide":"Show")](),this.$colorPicker.toggleClass("wColorPicker-visible"))},_noneEffectShow:function(){this.$colorPicker.css("display","inline-block")},_noneEffectHide:function(){this.$colorPicker.hide()},_fadeEffectShow:function(){this.$colorPicker.stop(!0,!1).css({display:"inline-block"}).animate({opacity:1},this.options.showSpeed)},_fadeEffectHide:function(){this.$colorPicker.stop(!0,!1).animate({opacity:0},this.options.hideSpeed,a.proxy(function(){this.$colorPicker.hide()},this))},_slideEffectShow:function(){var a="y"===this.positionAxis?{height:this.height}:{width:this.width};this.$colorPicker.css("display","inline-block"),this.$colorPickerHolder.stop(!0,!1).animate(a,this.options.showSpeed)},_slideEffectHide:function(){var b="y"===this.positionAxis?{height:0}:{width:0};this.$colorPickerHolder.stop(!0,!1).animate(b,this.options.hideSpeed,a.proxy(function(){this.$colorPicker.hide()},this))}},a.fn.wColorPicker=function(c,d){function e(d){var e,f=a.data(d,"wColorPicker");return f||(e=a.extend({},a.fn.wColorPicker.defaults,c),e.color=window.rgbHex(e.color)?e.color:"transparent",f=new b(d,e),a.data(d,"wColorPicker",f)),f}if("string"==typeof c){var f=[],g=null,h=null,i=null;return h=this.each(function(){g=a(this).data("wColorPicker"),g&&(i=(d?"set":"get")+c.charAt(0).toUpperCase()+c.substring(1).toLowerCase(),g[c]?f.push(g[c].apply(g,[d])):d?(g[i]&&g[i].apply(g,[d]),g.options[c]&&(g.options[c]=d)):g[i]?f.push(g[i].apply(g,[d])):g.options[c]?f.push(g.options[c]):f.push(null))}),1===f.length?f[0]:f.length>0?f:h}return this.each(function(){e(this)})},a.fn.wColorPicker.defaults={theme:"classic",opacity:.9,color:"#FF0000",mode:"flat",position:"bl",generateButton:!0,dropperButton:!1,effect:"slide",showSpeed:500,hideSpeed:500,onMouseover:null,onMouseout:null,onSelect:null,onDropper:null},a.fn.wColorPicker.mixedColors=[["#000000","#003300","#006600","#009900","#00CC00","#00FF00","#330000","#333300","#336600","#339900","#33CC00","#33FF00","#660000","#663300","#666600","#669900","#66CC00","#66FF00"],["#000033","#003333","#006633","#009933","#00CC33","#00FF33","#330033","#333333","#336633","#339933","#33CC33","#33FF33","#660033","#663333","#666633","#669933","#66CC33","#66FF33"],["#000066","#003366","#006666","#009966","#00CC66","#00FF66","#330066","#333366","#336666","#339966","#33CC66","#33FF66","#660066","#663366","#666666","#669966","#66CC66","#66FF66"],["#000099","#003399","#006699","#009999","#00CC99","#00FF99","#330099","#333399","#336699","#339999","#33CC99","#33FF99","#660099","#663399","#666699","#669999","#66CC99","#66FF99"],["#0000CC","#0033CC","#0066CC","#0099CC","#00CCCC","#00FFCC","#3300CC","#3333CC","#3366CC","#3399CC","#33CCCC","#33FFCC","#6600CC","#6633CC","#6666CC","#6699CC","#66CCCC","#66FFCC"],["#0000FF","#0033FF","#0066FF","#0099FF","#00CCFF","#00FFFF","#3300FF","#3333FF","#3366FF","#3399FF","#33CCFF","#33FFFF","#6600FF","#6633FF","#6666FF","#6699FF","#66CCFF","#66FFFF"],["#990000","#993300","#996600","#999900","#99CC00","#99FF00","#CC0000","#CC3300","#CC6600","#CC9900","#CCCC00","#CCFF00","#FF0000","#FF3300","#FF6600","#FF9900","#FFCC00","#FFFF00"],["#990033","#993333","#996633","#999933","#99CC33","#99FF33","#CC0033","#CC3333","#CC6633","#CC9933","#CCCC33","#CCFF33","#FF0033","#FF3333","#FF6633","#FF9933","#FFCC33","#FFFF33"],["#990066","#993366","#996666","#999966","#99CC66","#99FF66","#CC0066","#CC3366","#CC6666","#CC9966","#CCCC66","#CCFF66","#FF0066","#FF3366","#FF6666","#FF9966","#FFCC66","#FFFF66"],["#990099","#993399","#996699","#999999","#99CC99","#99FF99","#CC0099","#CC3399","#CC6699","#CC9999","#CCCC99","#CCFF99","#FF0099","#FF3399","#FF6699","#FF9999","#FFCC99","#FFFF99"],["#9900CC","#9933CC","#9966CC","#9999CC","#99CCCC","#99FFCC","#CC00CC","#CC33CC","#CC66CC","#CC99CC","#CCCCCC","#CCFFCC","#FF00CC","#FF33CC","#FF66CC","#FF99CC","#FFCCCC","#FFFFCC"],["#9900FF","#9933FF","#9966FF","#9999FF","#99CCFF","#99FFFF","#CC00FF","#CC33FF","#CC66FF","#CC99FF","#CCCCFF","#CCFFFF","#FF00FF","#FF33FF","#FF66FF","#FF99FF","#FFCCFF","#FFFFFF"]],a.fn.wColorPicker.simpleColors=[["#000000"],["#333333"],["#666666"],["#999999"],["#CCCCCC"],["#FFFFFF"],["#FF0000"],["#00FF00"],["#0000FF"],["#FFFF00"],["#00FFFF"],["#FF00FF"]]}(jQuery),!function(a){a.fn.wPaint.menus.main={img:"plugins/main/img/icons-menu-main.png",items:{undo:{icon:"generic",title:"Undo",index:0,callback:function(){this.undo()}},redo:{icon:"generic",title:"Redo",index:1,callback:function(){this.redo()}},clear:{icon:"generic",title:"Clear",index:2,callback:function(){this.clear()}},rectangle:{icon:"activate",title:"Rectangle",index:3,callback:function(){this.setMode("rectangle")}},ellipse:{icon:"activate",title:"Ellipse",index:4,callback:function(){this.setMode("ellipse")}},line:{icon:"activate",title:"Line",index:5,callback:function(){this.setMode("line")}},pencil:{icon:"activate",title:"Pencil",index:6,callback:function(){this.setMode("pencil")}},eraser:{icon:"activate",title:"Eraser",index:8,callback:function(){this.setMode("eraser")}},bucket:{icon:"activate",title:"Bucket",index:9,callback:function(){this.setMode("bucket")}},fillStyle:{title:"Fill Color",icon:"colorPicker",callback:function(a){this.setFillStyle(a)}},lineWidth:{icon:"select",title:"Stroke Width",range:[1,2,3,4,5,6,7,8,9,10],value:2,callback:function(a){this.setLineWidth(a)}},strokeStyle:{icon:"colorPicker",title:"Stroke Color",callback:function(a){this.setStrokeStyle(a)}}}},a.extend(a.fn.wPaint.cursors,{"default":{path:"plugins/main/img/cursor-crosshair.png",left:7,top:7},dropper:{path:"plugins/main/img/cursor-dropper.png",left:0,top:12},pencil:{path:"plugins/main/img/cursor-pencil.png",left:0,top:11.99},bucket:{path:"plugins/main/img/cursor-bucket.png",left:0,top:10},eraser1:{path:"plugins/main/img/cursor-eraser1.png",left:1,top:1},eraser2:{path:"plugins/main/img/cursor-eraser2.png",left:2,top:2},eraser3:{path:"plugins/main/img/cursor-eraser3.png",left:2,top:2},eraser4:{path:"plugins/main/img/cursor-eraser4.png",left:3,top:3},eraser5:{path:"plugins/main/img/cursor-eraser5.png",left:3,top:3},eraser6:{path:"plugins/main/img/cursor-eraser6.png",left:4,top:4},eraser7:{path:"plugins/main/img/cursor-eraser7.png",left:4,top:4},eraser8:{path:"plugins/main/img/cursor-eraser8.png",left:5,top:5},eraser9:{path:"plugins/main/img/cursor-eraser9.png",left:5,top:5},eraser10:{path:"plugins/main/img/cursor-eraser10.png",left:6,top:6}}),a.extend(a.fn.wPaint.defaults,{mode:"pencil",lineWidth:"3",fillStyle:"#FFFFFF",strokeStyle:"#FFFF00"}),a.fn.wPaint.extend({undoCurrent:-1,undoArray:[],setUndoFlag:!0,generate:function(){this.menus.all.main=this._createMenu("main",{offsetLeft:this.options.menuOffsetLeft,offsetTop:this.options.menuOffsetTop})},_init:function(){this._addUndo(),this.menus.all.main._setIconDisabled("clear",!0)},setStrokeStyle:function(a){this.options.strokeStyle=a,this.menus.all.main._setColorPickerValue("strokeStyle",a)},setLineWidth:function(a){this.options.lineWidth=a,this.menus.all.main._setSelectValue("lineWidth",a),this.setCursor(this.options.mode)},setFillStyle:function(a){this.options.fillStyle=a,this.menus.all.main._setColorPickerValue("fillStyle",a)},setCursor:function(a){"eraser"===a&&this.setCursor("eraser"+this.options.lineWidth)},undo:function(){this.undoArray[this.undoCurrent-1]&&this._setUndo(--this.undoCurrent),this._undoToggleIcons()},redo:function(){this.undoArray[this.undoCurrent+1]&&this._setUndo(++this.undoCurrent),this._undoToggleIcons()},_addUndo:function(){for(this.undoCurrent<this.undoArray.length-1?this.undoArray[++this.undoCurrent]=this.getImage(!1):(this.undoArray.push(this.getImage(!1)),this.undoArray.length>this.undoMax?this.undoArray=this.undoArray.slice(1,this.undoArray.length):this.undoCurrent++);this.undoCurrent!==this.undoArray.length-1;)this.undoArray.pop();this._undoToggleIcons(),this.menus.all.main._setIconDisabled("clear",!1)},_undoToggleIcons:function(){var a=this.undoCurrent>0&&this.undoArray.length>1?0:1,b=this.undoCurrent<this.undoArray.length-1?2:3;this.menus.all.main._setIconDisabled("undo",1===a?!0:!1),this.menus.all.main._setIconDisabled("redo",3===b?!0:!1)},_setUndo:function(a){this.setUndoFlag=!1,this.setImage(this.undoArray[a])},_imageOnload:function(){this.setUndoFlag&&this._addUndo(),this.setUndoFlag=!0},clear:function(){this.menus.all.main._isIconDisabled("clear")||(this.ctx.clearRect(0,0,this.width,this.height),this._addUndo(),this.menus.all.main._setIconDisabled("clear",!0))},_drawRectangleDown:function(a){this._drawShapeDown(a)},_drawRectangleMove:function(a){this._drawShapeMove(a),this.ctxTemp.rect(a.x,a.y,a.w,a.h),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawRectangleUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawEllipseDown:function(a){this._drawShapeDown(a)},_drawEllipseMove:function(a){this._drawShapeMove(a),this.ctxTemp.ellipse(a.x,a.y,a.w,a.h),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawEllipseUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawLineDown:function(a){this._drawShapeDown(a)},_drawLineMove:function(a){this._drawShapeMove(a,1);var b=this.canvasTempLeftOriginal,c=this.canvasTempTopOriginal;a.pageX<b&&(a.x=a.x+a.w,a.w=-1*a.w),a.pageY<c&&(a.y=a.y+a.h,a.h=-1*a.h),this.ctxTemp.lineJoin="round",this.ctxTemp.beginPath(),this.ctxTemp.moveTo(a.x,a.y),this.ctxTemp.lineTo(a.x+a.w,a.y+a.h),this.ctxTemp.closePath(),this.ctxTemp.stroke()},_drawLineUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawPencilDown:function(a){this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.strokeStyle=this.options.strokeStyle,this.ctx.fillStyle=this.options.strokeStyle,this.ctx.lineWidth=this.options.lineWidth,this.ctx.beginPath(),this.ctx.arc(a.pageX,a.pageY,this.options.lineWidth/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.beginPath(),this.ctx.moveTo(a.pageX,a.pageY)},_drawPencilMove:function(a){this.ctx.lineTo(a.pageX,a.pageY),this.ctx.stroke()},_drawPencilUp:function(){this.ctx.closePath(),this._addUndo()},_drawEraserDown:function(a){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this._drawPencilDown(a)},_drawEraserMove:function(a){this._drawPencilMove(a)},_drawEraserUp:function(a){this._drawPencilUp(a),this.ctx.restore()},_drawBucketDown:function(a){this.ctx.fillArea(a.pageX,a.pageY,this.options.fillStyle),this._addUndo()}})}(jQuery),!function(){window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.fillArea=function(a,b,c){function d(a){return{r:p[a],g:p[a+1],b:p[a+2],a:p[a+3]}}function e(a){p[a]=c.r,p[a+1]=c.g,p[a+2]=c.b,p[a+3]=c.a}function f(a){return g.r===a.r&&g.g===a.g&&g.b===a.b&&g.a===a.a}if(!a||!b||!c)return!0;var g,h,i,j,k,l,m=this.canvas.width,n=this.canvas.height,o=this.getImageData(0,0,m,n),p=o.data,q=[[a,b]];if(g=d(4*(b*m+a)),l=this.canvas.style.color,this.canvas.style.color=c,c=this.canvas.style.color.match(/^rgba?\((.*)\);?$/)[1].split(","),this.canvas.style.color=l,c={r:parseInt(c[0],10),g:parseInt(c[1],10),b:parseInt(c[2],10),a:parseInt(c[3]||255,10)},f(c))return!0;for(;q.length;){for(h=q.pop(),i=4*(h[1]*m+h[0]);h[1]-->=0&&f(d(i));)i-=4*m;for(i+=4*m,++h[1],j=!1,k=!1;h[1]++<n-1&&f(d(i));)e(i),h[0]>0&&(f(d(i-4))?j||(q.push([h[0]-1,h[1]]),j=!0):j&&(j=!1)),h[0]<m-1&&(f(d(i+4))?k||(q.push([h[0]+1,h[1]]),k=!0):k&&(k=!1)),i+=4*m}this.putImageData(o,0,0)})}(),!function(a){a.fn.wPaint.menus.text={img:"plugins/text/img/icons-menu-text.png",items:{bold:{icon:"toggle",title:"Bold",index:0,callback:function(a){this.setFontBold(a)}},italic:{icon:"toggle",title:"Italic",index:1,callback:function(a){this.setFontItalic(a)}},fontSize:{title:"Font Size",icon:"select",range:[8,9,10,12,14,16,20,24,30],value:12,callback:function(a){this.setFontSize(a)}},fontFamily:{icon:"select",title:"Font Family",range:["Arial","Courier","Times","Verdana"],useRange:!0,value:"Arial",callback:function(a){this.setFontFamily(a)}}}},a.fn.wPaint.menus.main.items.text={icon:"menu",after:"pencil",title:"Text",index:7,callback:function(){this.setMode("text")}},a.extend(a.fn.wPaint.defaults,{fontSize:"12",fontFamily:"Arial",fontBold:!1,fontItalic:!1,fontUnderline:!1}),a.fn.wPaint.extend({generate:function(){this.$textCalc=a("<div></div>").hide(),this.$textInput=a('<textarea class="wPaint-text-input" spellcheck="false"></textarea>').on("mousedown",this._stopPropagation).css({position:"absolute"}).hide(),a("body").append(this.$textCalc),this.$el.append(this.$textInput),this.menus.all.text=this._createMenu("text")},_init:function(){function b(){c._drawTextIfNotEmpty(),c.$textInput.hide(),c.$canvasTemp.hide()}var c=this;for(var d in this.menus.all)this.menus.all[d].$menu.on("click",b).on("mousedown",this._stopPropagation);a(document).on("mousedown",b)},setFillStyle:function(a){this.$textInput.css("color",a)},setFontSize:function(a){this.options.fontSize=parseInt(a,10),this._setFont({fontSize:a+"px",lineHeight:a+"px"}),this.menus.all.text._setSelectValue("fontSize",a)},setFontFamily:function(a){this.options.fontFamily=a,this._setFont({fontFamily:a}),this.menus.all.text._setSelectValue("fontFamily",a)},setFontBold:function(a){this.options.fontBold=a,this._setFont({fontWeight:a?"bold":""})},setFontItalic:function(a){this.options.fontItalic=a,this._setFont({fontStyle:a?"italic":""})},setFontUnderline:function(a){this.options.fontUnderline=a,this._setFont({fontWeight:a?"underline":""})},_setFont:function(a){this.$textInput.css(a),this.$textCalc.css(a)},_drawTextDown:function(a){this._drawTextIfNotEmpty(),this._drawShapeDown(a,1),this.$textInput.css({left:a.pageX-1,top:a.pageY-1,width:0,height:0}).show().focus()},_drawTextMove:function(a){this._drawShapeMove(a,1),this.$textInput.css({left:a.left-1,top:a.top-1,width:a.width,height:a.height})},_drawTextIfNotEmpty:function(){""!==this.$textInput.val()&&this._drawText()},_drawText:function(){var a,b,c,d,e="",f=this.$textInput.val().split("\n"),g=[],h=this.$textInput.width()-2,i=0,j=0,k=this.$textInput.position(),l=k.left+1,m=k.top+1;for(this.options.fontItalic&&(e+="italic "),this.options.fontBold&&(e+="bold "),e+=this.options.fontSize+"px "+this.options.fontFamily,a=0,b=f.length;b>a;a++){for(this.$textCalc.html(""),j=0,c=0,d=f[0].length;d>c;c++)i=this.$textCalc.append(f[a][c]).width(),i>h&&(g.push(f[a].substring(j,c)),j=c,this.$textCalc.html(f[a][c]));j!==c&&g.push(f[a].substring(j,c))}for(f=this.$textInput.val(g.join("\n")).val().split("\n"),a=0,b=f.length;b>a;a++)this.ctx.fillStyle=this.options.fillStyle,this.ctx.textBaseline="top",this.ctx.font=e,this.ctx.fillText(f[a],l,m),m+=this.options.fontSize;this.$textInput.val(""),this._addUndo()}})}(jQuery),!function(a){var b="plugins/shapes/img/icons-menu-main-shapes.png";a.extend(!0,a.fn.wPaint.menus.main.items,{rectangle:{group:"shapes"},roundedRect:{icon:"activate",group:"shapes",title:"Rounded Rectangle",img:b,index:0,callback:function(){this.setMode("roundedRect")
}},square:{icon:"activate",group:"shapes",title:"Square",img:b,index:1,callback:function(){this.setMode("square")}},roundedSquare:{icon:"activate",group:"shapes",title:"Rounded Square",img:b,index:2,callback:function(){this.setMode("roundedSquare")}},diamond:{icon:"activate",group:"shapes",title:"Diamond",img:b,index:4,callback:function(){this.setMode("diamond")}},ellipse:{group:"shapes2"},circle:{icon:"activate",group:"shapes2",title:"Circle",img:b,index:3,callback:function(){this.setMode("circle")}},pentagon:{icon:"activate",group:"shapes2",title:"Pentagon",img:b,index:5,callback:function(){this.setMode("pentagon")}},hexagon:{icon:"activate",group:"shapes2",title:"Hexagon",img:b,index:6,callback:function(){this.setMode("hexagon")}}}),a.fn.wPaint.extend({_drawRoundedRectDown:function(a){this._drawShapeDown(a)},_drawRoundedRectMove:function(a){this._drawShapeMove(a);var b=a.w>a.h?a.h/a.w:a.w/a.h;this.ctxTemp.roundedRect(a.x,a.y,a.w,a.h,Math.ceil(.001*b*a.w*a.h)),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawRoundedRectUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawSquareDown:function(a){this._drawShapeDown(a)},_drawSquareMove:function(a){this._drawShapeMove(a);var b=a.w>a.h?a.h:a.w;this.ctxTemp.rect(a.x,a.y,b,b),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawSquareUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawRoundedSquareDown:function(a){this._drawShapeDown(a)},_drawRoundedSquareMove:function(a){this._drawShapeMove(a);var b=a.w>a.h?a.h:a.w;this.ctxTemp.roundedRect(a.x,a.y,b,b,Math.ceil(.001*b*b)),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawRoundedSquareUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawDiamondDown:function(a){this._drawShapeDown(a)},_drawDiamondMove:function(a){this._drawShapeMove(a),this.ctxTemp.diamond(a.x,a.y,a.w,a.h),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawDiamondUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawCircleDown:function(a){this._drawShapeDown(a)},_drawCircleMove:function(a){this._drawShapeMove(a);var b=a.w>a.h?a.h:a.w;this.ctxTemp.ellipse(a.x,a.y,b,b),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawCircleUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawPentagonDown:function(a){this._drawShapeDown(a)},_drawPentagonMove:function(a){this._drawShapeMove(a),this.ctxTemp.pentagon(a.x,a.y,a.w,a.h),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawPentagonUp:function(a){this._drawShapeUp(a),this._addUndo()},_drawHexagonDown:function(a){this._drawShapeDown(a)},_drawHexagonMove:function(a){this._drawShapeMove(a),this.ctxTemp.hexagon(a.x,a.y,a.w,a.h),this.ctxTemp.stroke(),this.ctxTemp.fill()},_drawHexagonUp:function(a){this._drawShapeUp(a),this._addUndo()}})}(jQuery),!function(){window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.diamond=function(a,b,c,d){return a&&b&&c&&d?(this.beginPath(),this.moveTo(a+.5*c,b),this.lineTo(a,b+.5*d),this.lineTo(a+.5*c,b+d),this.lineTo(a+c,b+.5*d),this.lineTo(a+.5*c,b),this.closePath(),void 0):!0}),window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.ellipse=function(a,b,c,d){if(!(a&&b&&c&&d))return!0;var e=.5522848,f=c/2*e,g=d/2*e,h=a+c,i=b+d,j=a+c/2,k=b+d/2;this.beginPath(),this.moveTo(a,k),this.bezierCurveTo(a,k-g,j-f,b,j,b),this.bezierCurveTo(j+f,b,h,k-g,h,k),this.bezierCurveTo(h,k+g,j+f,i,j,i),this.bezierCurveTo(j-f,i,a,k+g,a,k),this.closePath()}),window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.hexagon=function(a,b,c,d){if(!(a&&b&&c&&d))return!0;var e=.225,f=1-e;this.beginPath(),this.moveTo(a+.5*c,b),this.lineTo(a,b+d*e),this.lineTo(a,b+d*f),this.lineTo(a+.5*c,b+d),this.lineTo(a+c,b+d*f),this.lineTo(a+c,b+d*e),this.lineTo(a+.5*c,b),this.closePath()}),window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.pentagon=function(a,b,c,d){return a&&b&&c&&d?(this.beginPath(),this.moveTo(a+c/2,b),this.lineTo(a,b+.4*d),this.lineTo(a+.2*c,b+d),this.lineTo(a+.8*c,b+d),this.lineTo(a+c,b+.4*d),this.lineTo(a+c/2,b),this.closePath(),void 0):!0}),window.CanvasRenderingContext2D&&(CanvasRenderingContext2D.prototype.roundedRect=function(a,b,c,d,e){return a&&b&&c&&d?(e||(e=5),this.beginPath(),this.moveTo(a+e,b),this.lineTo(a+c-e,b),this.quadraticCurveTo(a+c,b,a+c,b+e),this.lineTo(a+c,b+d-e),this.quadraticCurveTo(a+c,b+d,a+c-e,b+d),this.lineTo(a+e,b+d),this.quadraticCurveTo(a,b+d,a,b+d-e),this.lineTo(a,b+e),this.quadraticCurveTo(a,b,a+e,b),this.closePath(),void 0):!0})}(),ModelProperty.prototype.set=function(a){if(a!==this.value){console.log("set",this.name,a),this.value=a;for(var b=this.changeListeners,c=0;c<b.length;c++)b[c].call(this,this.value)}},ModelProperty.prototype.get=function(){return this.value},ModelProperty.prototype.addChangeListener=function(a){this.changeListeners.push(a)},Model.prototype.get=function(a){if(!this.exists(a))throw new Error("property "+a+" not in model.");return this.properties[a]},Model.prototype.getVal=function(a){return this.get(a).get()},Model.prototype.exists=function(a){return a in this.properties},function(a){a.fn.sgLabel=function(){return this.each(function(){var b=a("<label class='controlLabel' />");b.attr({"for":a(this).attr("id"),title:a(this).attr("title")}),b.text(a(this).attr("data-label")),a(this).before(b),b.tooltip()})},a.fn.sgKnob=function(b,c,d,e,f){return this.each(function(){e=e||1,f=f||1;var g=a(this);g.tooltip(),g.sgLabel(),g.bind("change",function(){b.set(parseInt(g.val(),10)/e)}),g.val(b.get()*e),g.knob({width:50,height:50,fgColor:"ffec03",inputColor:"#ffec03",thickness:.3,bgColor:"#202020",displayPrevious:!0,step:f,min:c,max:d,change:function(a){var c=Math.floor(a-a%f)/e;b.set(c)}}),b.addChangeListener(function(a){g.val(a*e),g.trigger("change")})})},a.fn.sgDropdown=function(b,c){var d="number"==typeof b.get();return this.each(function(){var e=a(this);a.each(c,function(b,c){e.append(a("<option></option>").attr("value",c).text(c))}),e.val(b.get()),e.bind("change",function(){var a=e.val();d&&(a=parseInt(a,10)),b.set(a)}),e.sgLabel(),b.addChangeListener(function(a){e.val(a)})})},a.fn.sgStepDurationSlider=function(b){var c=1e3/b.get("stepDuration");a("#stepDuration").val(c),a("#stepDurationSlider").slider({min:1,max:120,value:c,orientation:"vertical",change:function(b,c){a("#stepDuration").val(c.value),a("#stepDuration").trigger("change")}}),a("#stepDuration").bind("change",function(){b.set(1e3*(1/a(this).val()))}),a("#stepDuration").bindMobileEvents(),b.addChangeListener(function(b){a("#stepDuration").val(1e3/b),a("#stepDurationSlider").slider("value",1e3/b)})},a.fn.sgStartupTooltip=function(b,c){return this.each(function(){var d=a(this);window.setTimeout(function(){console.log("open",a(this)),d.tooltip("open"),window.setTimeout(function(){console.log("close"),d.tooltip("close"),d.tooltip("disable")},c)},b)})},a.fn.sgGrid=function(b,c){var d=a(this)[0],e=d.getContext("2d");e.fillStyle="rgba(0,0,0,0.2)";var f=d.width,g=d.height;e.clearRect(0,0,f,g);for(var h=0;f>h;h+=b)e.fillRect(h,0,1,g);for(var i=0;g>i;i+=c)e.fillRect(0,parseInt(i,10),f,1)},a.fn.sgGridLabels=function(b,c){var d=a(this)[0],e=d.height,f=d.getContext("2d");f.fillStyle=this.css("color"),f.font=this.css("font-size")+" Calibri",f.clearRect(0,0,d.width,e);for(var g=b/2;g<d.height;g+=b){var h=c(g);f.fillText(h,2,g+3)}}}(jQuery),function(a){a.fn.wPaint.menus.main.items.note={icon:"activate",title:"Note",img:"../../css/note-icon.png",index:0,callback:function(){this.setMode("Note")}},a.extend(a.fn.wPaint.defaults,{snapGridVertical:5,snapGridHorizontal:10}),a.fn.wPaint.extend({_drawNoteDown:function(a){var b=this.options.snapGridHorizontal,c=this.options.snapGridVertical,d=a.pageX-a.pageX%b,e=a.pageY-a.pageY%c,f=Math.floor(e+c-Math.floor(e));this.ctx.strokeStyle=this.options.strokeStyle,this.ctx.fillStyle=this.options.strokeStyle,this.ctx.fillRect(Math.floor(d),Math.floor(e),Math.floor(b),f),console.log("draw note",Math.floor(d),Math.floor(e),Math.floor(b),f,b,c)},_drawNoteMove:function(a){this._drawNoteDown(a)},_drawNoteUp:function(){this._addUndo()}})}(jQuery);